name: Auto Release & Publish

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md' # Ignores README changes to prevent unnecessary builds
      - '.github/workflows/release.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push the new tag and commit
      packages: write  # Required to publish artifacts to GitHub Packages

    steps:
      # 1. Checkout Code
      - uses: actions/checkout@v4

      # 2. Setup Java 21 & Maven Settings
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          server-id: github # Must match <id>github</id> in your pom.xml distributionManagement
          settings-path: ${{ github.workspace }}

      # 3. Set Release Version (Remove Snapshot)
      - name: Set Release Version
        id: version
        run: |
          # Remove -SNAPSHOT from the current version
          mvn versions:set -DremoveSnapshot -DgenerateBackupPoms=false -DprocessAllModules=true
          
          # Extract the new version
          MVN_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          NEW_TAG="v$MVN_VERSION"
          
          echo "New Tag: $NEW_TAG"
          echo "Maven Version: $MVN_VERSION"
          
          # Save to Env variables for next steps
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "MVN_VERSION=$MVN_VERSION" >> $GITHUB_ENV

      # 4. Build (Skipping Tests)
      - name: Build and Verify
        run: mvn clean verify -DskipTests

      # 5. Commit Version Bump & Push Tag
      - name: Commit and Push Release
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage only modified tracked files (pom.xml updates)
          git add -u
          
          # Commit with [skip ci] to prevent infinite loop
          git commit -m "Bump version to ${{ env.NEW_TAG }} [skip ci]"
          git push origin main
          
          # Create and push the tag
          git tag ${{ env.NEW_TAG }}
          git push origin ${{ env.NEW_TAG }}

      # 6. Publish to GitHub Packages
      - name: Publish to GitHub Packages
        run: mvn deploy -s $GITHUB_WORKSPACE/settings.xml -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. Prepare Next Snapshot
      - name: Prepare Next Snapshot
        run: |
          # Calculate next snapshot version
          IFS='.' read -r -a PARTS <<< "${{ env.MVN_VERSION }}"
          NEXT_PATCH=$((PARTS[2] + 1))
          NEXT_SNAPSHOT="${PARTS[0]}.${PARTS[1]}.$NEXT_PATCH-SNAPSHOT"
          
          echo "Setting next snapshot version: $NEXT_SNAPSHOT"
          
          # Update pom.xml
          mvn versions:set -DnewVersion=$NEXT_SNAPSHOT -DgenerateBackupPoms=false -DprocessAllModules=true
          
          # Commit and Push
          git add -u
          git commit -m "Prepare for next development iteration $NEXT_SNAPSHOT [skip ci]"
          git push origin main
